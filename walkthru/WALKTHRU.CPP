/*------------------------------------------------------------------------------ * Virtus WalkThrough_ * Version 1.1.1  * * Copyright _ 1990-1992 by Virtus Corporation * All Rights Reserved * Written by   *				 *				Mark J. Uland * Virtus Corporation * Suite 204 * 117 Edinburgh South * Cary, North Carolina    27511 * (919) 467-9700 *------------------------------------------------------------------------------ * Source File:  * Notes:  * History:  *------------------------------------------------------------------------------ */#include "VTypes.h"#include "VToolbox.h"#include "WalkThru.h"#include "Library.h"#include "WMenus.h"#include "CVWCntrl.h"#include "Observer.h"#include "CVLItem.h"#include "Drawing.h"#include "UndoBuf.h"#include "UndoSpec.h"#include "ToolDef.h"#include "Clip.h"#include "View.h"	//MERGE-PRO-JAM-2#if THINK_C			// PRO25#include "XDXF3D.h"#include "XDXF2D.h"#else#include "XDXF3D-PPC.h"#include "XDXF2D-PPC.h"#endif#include "XMDrawII.h"#include "XCCAD.h"#include "DXF_IN.h"#include "QuickTim.h"#include "DlogTran.h"#include "DlogPref.h"//#include "DlogExp.h"#include "ScoreCrd.h"#include "VgerFile.h"#include "AVIMovie.h"#include "AppMssgs.h"#include "AppDeflt.h"#include "AppText.h"#include "AppFiles.h"#if VRML_ANCHOR#include "Exp2VRML.h" // DAS VRML 95.03.24		// PRO25#endif // VRML_ANCHOR#include "VAbout.h"#include "VWindow.h"#include "VError.h"#include "VTextDef.h"#include "VGUtil.h"#include "TextArry.h"#include "VMain.h"#include "VWndUtls.h"	// MERGE19#include "TextSrvr.h"	// ABD MERGE-TEXTURE 9/13/93#include "InitText.h"	// JAM 28 Oct 93#include "ObjPrClp.h"	// JAM 3 Mar 94#include "DesCntrl.h"#if VR#include "VWI.h" 		//DAS-VWI#include "VRLibs.h"		// ABD MERGE3 8/19/93 WILLIAMS#include "VRIcon.h"		// jca 25 Sept 93#endif //VR#include "Gouraud.h"	// MERGE-GOURAUD#if SPECIAL_EDITION         	// merge SE, vrmadness		// GJR 7/4/95#include "Blurbs.h"#endif //SPECIAL_EDITION		// merge SE, vrmadness		// GJR 7/4/95#if DLLMOVESOBSERVER#include "worldDLL.h"#endif DLLMOVESOBSERVER#include <string.h>#include <stdio.h>//JAM 1-27-95 [[[#define MAXFILENAMELENGTH 31//JAM 1-27-95 ]]]/* current top corner of the document windows */V_Buffer	*clipBuf;WalkDocumentStub *GlbSameDocument(WalkDocumentStub *,V_File *file);void CleanUpSrfObjStatics(void); // jam 6OCT94 jca VR1.0.1 10AUG94 clean up after ourselves#define MAX_FILENAME_LENGTH	31int GetTrailerNumber(char *);voidStartUp()	{	WalkDocumentStub *stubby;	WalkDocumentStub *doc;	extern struct TextureServer *gTextureServer;		// ABD MERGE-TEXTURE 9/13/93	extern int docCount; // DAS-VR-VDOCUMENT 9/29/93 - don't increase the document number#if VR	docCount=-1;		// DAS-VR-VDOCUMENT 9/29/93 - don't increase the document number	InitVRIconCaches();		// jca 18 Oct 93	this is so the icons won't be in 40-50 offscreens, each of which take 8-10K.#endif	gTextureServer = new(TextureServer);	// ABD MERGE-TEXTURE 9/13/93	gTextureServer->cTextureServer();		// ABD MERGE-TEXTURE 9/13/93	InitTextureMapping();		// JAM 28 Oct 93	InitGouraud();				// MERGE-GOURAUD	InitClipping();				// JAM 3 Mar 94	InitSpacialClip();			// JAM 19 Aug 94	//FASTERSPACIALCLIP#if DLLMOVESOBSERVER	InitDLLToMoveObserver();#endif	VSplashScreen();	theCreator=appFileCreator;//JCA 16FEB94 remove!!!!   #if MACINTOSH || VR	stubby = new(WalkDocumentStub);	stubby->OpenDocument(INIT,NULL,NoMDI);	SetStub(stubby);/* jca 16FEB94 REMOVE!!!!  #elif WINDOWS && VWT	SetStub(NULL);#endif //MACINTOSH  */	clipBuf = new(V_Buffer);	clipBuf->cBuffer(DATA_OUT);		gUndoArray = new(V_Array);	gUndoArray->cArray(0,sizeof(EditSpecList*),4);#if VR	VRLibsInit();				// ABD MERGE3 8/19/93 WILLIAMS#if VR_CACHE_TEXTURE_ICONS		// jca 18 OCt 93 {	if (globalTextureIcons)	globalTextureIcons->Compact(1);		// tighten up our use of memory--we're not going to load any more textures#endif // VR_CACHE_TEXTURE_ICONS // jca 18 Oct 93#endif //VR#if SPECIAL_EDITION	&& ENGLISH		// merge SE, vrmadness		// GJR 7/4/95	Blurb(NULL);#endif // SPECIAL_EDITION	}	voidEndIt()	{	EditSpecList	**undoItems;	int			i,length;	extern TextureArray *gInUseTextures;  //jam vr1.0.1 needs to be deleted if it exists#if SPECIAL_EDITION	&& ENGLISH		// merge SE, vrmadness		// GJR 7/4/95	Blurb(NULL);#endif // SPECIAL_EDITION	length = gUndoArray->ALength();	undoItems = (EditSpecList**)gUndoArray->Use();	for(i = 0; i < length; i++,undoItems++)		(*undoItems)->dArray();	gUndoArray->Unuse();		gUndoArray->dArray();	clipBuf->dBuffer();	gTextureServer->dTextureServer();	EndTextureMapping();			// JAM 28 Oct 93	EndGouraud();					// JAM 6 Oct 94	EndClipping();					// JAM 3 Mar 94	EndSpacialClip();				// JAM 19 Aug 94 FASTERSPACIALCLIP#if DLLMOVESOBSERVER	EndDLLToMoveObserver();#endif#if VR	VRLibsDelete();			// MERGE-CLEANUP	EndVRIconCaches();		// jca 25 Sept 93#endif // VR		if(gInUseTextures) gInUseTextures;  //jam vr1.0.1 needs to be deleted if it exists	CleanUpSrfObjStatics();	// JCA 10aug94 VR1.0.1	tidy up after ourselves	}WalkDocumentStub *GlbSameDocument(WalkDocumentStub *newDoc,V_File *file)	{	WalkDocumentStub 	*sameDoc;	WalkDocumentStub	**doc;	int					i,length;		sameDoc = NULL;	length = theSuper->ALength();	doc = (WalkDocumentStub	**)theSuper->Use();	for(i = 0; i < length; i++,doc++)		if((newDoc != *doc) && (*doc)->SameFile(file)) 			{			sameDoc = *doc;			break;			}	theSuper->Unuse();		return(sameDoc);	}	voidNewDocument(V_File *file,int flag)	{	WalkDocumentStub 	*doc;	long 				form,size,type;	int 				i,length,err;#if WINDOWS	char				errorMsg[256];	char				pathString[256];#endif#if VR	extern V_Array  *gGalleries3D;		// array of library files	int				found = FALSE;	V_File			*vrLib;	VfsLocation 	*oldLocation;						//GJR 10/06/93    V_Document		*closingDoc;#endif //VR#if VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness	extern int gNextTextureLib;		// MERGE23#endif // VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness#if VWT && SPECIAL_EDITION 	// merge SE, vrmadness		// GJR 7/4/95// jca 27AUG94 vrmadness	V_Document		*closingDoc;#endif // VWT && SPECIAL_EDITION 	// jca 27AUG94 vrmadness	if(file)		{				err = file->Open(FALSE);		if (!err)			{	// jca--don't try to do this if there's no such file!			file->IOType(&form,IO_LONG);			file->IOType(&size,IO_LONG);			file->IOType(&type,IO_LONG);			file->IOSetPosition(0L);			}		else        	type = 0L;		file->Close();					switch(type)			{				case IFF_VCLP:	//appFileTypeLibModel: <-- this is what it used to be.  IFF_VCLP is the way it's defined when the file is written out.  jca 4/25/93 		#if VWT				if(doc = GlbSameDocument(NULL,file))					doc->Activate(NULL);				else					{					doc = new(Library);#if VR					gNextTextureLib = 0;		// MERGE23#endif					doc->OpenDocument(flag,file, NewMDI);					}	#elif VR//REPLACE							//GJR 10/06/93				oldLocation = new(VfsLocation);                oldLocation->cVfsLocation();				file->VGetLocation(oldLocation);								for(i=0; i<gGalleries3D->ALength(); i++)					{					gGalleries3D->Get(i,&vrLib);															//GJR 10/06/93 [[[					if (vrLib->VIsSameLocation(oldLocation))						{						found = TRUE;						break;						}					}                oldLocation->dVfsLocation();				if (! found) i=0;				if ((ActiveDocument() != stub) && found)					{					((WalkDocument*)ActiveDocument())->InitLibs(i, 0);		// MERGE15					}				else if (found)					{					doc = new(WalkDocument);					gNextTextureLib = 0;		// MERGE23					doc->OpenDocument(NEW,NULL, NewMDI);					if (VARY_NOTFOUND != theSuper->Find(&doc))						doc->InitLibs(i, 0);		// MERGE15					}#endif //VWT				break;			case IFF_VMDL:	//appFileTypeModel: <-- this is what it used to be.  IFF_VMDL is the way it's defined when the file is written out.  jca 4/25/93							// merge SE, vrmadness		// GJR 7/4/95#if VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness				closingDoc = ActiveDocument();				if (closingDoc != stub)					switch(closingDoc->QSave())						{						case QCANCEL:break;						case QYES:							if(closingDoc->Untitled())								{ if(0!=closingDoc->Save(SAVEAS)) break; }	// jam 6OCT94 jca 16AUG94 VR1.0.1							else								{ if(0!=closingDoc->Save(SAVE)) break; }  	// jam 6OCT94 16AUG94 VR1.0.1						case QNO:							closingDoc->CloseDocument();							delete(closingDoc);							break;						}				if (ActiveDocument() != stub) break;				gNextTextureLib = 0;		// MERGE23#endif //VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness				doc = new(WalkDocument);				doc->OpenDocument(flag,file, NewMDI);#if VR				if (VARY_NOTFOUND != theSuper->Find(&doc))					doc->InitLibs(0, 0);		// MERGE15#endif //VR				break;			default:							// merge SE, vrmadness		// GJR 7/4/95#if VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness				closingDoc = ActiveDocument();				if (closingDoc != stub)					switch(closingDoc->QSave())						{						case QCANCEL:break;						case QYES:							if(closingDoc->Untitled())								{ if(0!=closingDoc->Save(SAVEAS)) break; }	// jca 16AUG94 VR1.0.1							else								{ if(0!=closingDoc->Save(SAVE)) break; }  	// jca 16AUG94 VR1.0.1						case QNO:							closingDoc->CloseDocument();							delete(closingDoc);							break;						}				if (ActiveDocument() != stub) break;#endif //VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness				doc = new(WalkDocument);				doc->OpenDocument(NEW,NULL, NewMDI);#if WINDOWS				// we really should tell them we couldn't load the file				file->GetFullPathStr(pathString);				sprintf(errorMsg, TXTW_CANTLOAD, pathString);                AlertMessage(errorMsg);#endif //WINDOWS				file->dFile();				break;			}		}		else		// file == NULL (open a blank document)		{							// merge SE, vrmadness		// GJR 7/4/95#if VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness		closingDoc = ActiveDocument();		if (closingDoc != stub)			switch(closingDoc->QSave())				{				case QCANCEL:break;				case QYES:					if(closingDoc->Untitled())					if(closingDoc->Untitled())						{ if(0!=closingDoc->Save(SAVEAS)) break; }	// jam 6OCT94 jca 16AUG94 VR1.0.1					else						{ if(0!=closingDoc->Save(SAVE)) break; }    // jam 6OCT94 jca 16AUG94 VR1.0.1				case QNO:					closingDoc->CloseDocument();					delete(closingDoc);					break;				}		if (ActiveDocument() != stub) return;		gNextTextureLib = 0;		// MERGE23#endif //VR || (VWT && SPECIAL_EDITION) 	// jca 27AUG94 vrmadness		doc = new(WalkDocument);		doc->OpenDocument(flag,NULL, NewMDI);#if VR		if (VARY_NOTFOUND != theSuper->Find(&doc))			doc->InitLibs(0, 0);		// MERGE15#endif //VR		}#if VR && WINDOWS	doc->MoveVRLib(FALSE);#endif //VR && WINDOWS	}intWalkDocument::cDocument(int query,V_File *file)	{	V_MenuMgr	*gmenu;	char	str[256];	int	result;	type = walkThroughDocument;	quickSnapNumber = 0;	quickVolume = 0;	strcpy(quickName,TXT_EMPTYSTRING);	gmenu = GetMenuMgr();	aboutMenu = new(MenuAbout);	aboutMenu->ctheMenu(this);	gmenu->Append(aboutMenu);	fileMenu = new(MenuFile);	fileMenu->ctheMenu(this);	gmenu->Append(fileMenu);	editMenu = new(MenuWalkEdit);	editMenu->ctheMenu(this);	gmenu->Append(editMenu);	#if VR		current_library_2d = NULL;	current_library_3d = NULL;	current_2d_library_num = -1;		// MERGE15	current_3d_library_num = -1;	currently_3d = FALSE;#endif // VR		walkFile = file;	if(walkFile)		{		walkFile->GetFName(str);		strcpy(title,str);		}	SetTitlePrefix(TXT_APPNAME);		frontWindowType = toolCRTLWalk;	LaunchController(toolCRTLWalk);	fileMenu->SetController(walkController);	editMenu->SetController(walkController);		if(file)walkFile = file;	else		{		walkFile = new(V_File);#if VPRO  //VPRO jam 13 JUL 94 ]]]  #if !SPECIAL_EDITION                // Special Edition, VRML	// GJR 07/12/95  		if (walkFile->use_alternate_type)		// PRO25			walkFile->cFile(query,appFileTypeModel, appFileCreator,appFilterDescriptorVPRO,TXTPF_MODEL);  		else			walkFile->cFile(query,appFileTypeModel, appFileCreator,appFilterDescriptorVPRO,TXTPF_MODEL);	#if WINDOWS 		// on the mac, the files are the same type.  Not so under Windows(tm)!		walkFile->AddFType(appFileTypeModel, appFilterDescriptorVR);		walkFile->AddFType(appFileTypeModel, appFilterDescriptorWALK);    	walkFile->AddFType(appFileTypeModel, appFilterDescriptorTEXTURELIB);	#if SPECIAL_EDITION && VRML_ANCHOR		walkFile->AddFType(appFileTypeModel, appFilterDescriptorVWTVRML);	#endif // WINDOWS	#endif // SPECIAL_EDITION && VRML_ANCHOR   RSH 16JULY95  #else //SPECIAL_EDITON VRML	#if !VRML_ANCHOR		walkFile->cFile(query,appFileTypeModel, appFileCreator,appFilterDescriptorWALK,TXTPF_MODEL);	#else		walkFile->cFile(query,appFileTypeModel, appFileCreator,appFilterDescriptorVWTVRML,TXTPF_MODEL);	#endif	#if WINDOWS && USE_HMD		walkFile->AddFType(appFileTypeModel, appFilterDescriptorAll);	#endif	#if WINDOWS && !USE_HMD 		// on the mac, the files are the same type.  Not so under Windows(tm)!		walkFile->AddFType(appFileTypeModel, appFilterDescriptorVPRO);		walkFile->AddFType(appFileTypeModel, appFilterDescriptorVR);		walkFile->AddFType(appFileTypeModel, appFilterDescriptorWALK);		walkFile->AddFType(appFileTypeModel, appFilterDescriptorTEXTURELIB);	#endif // WINDOWS  #endif#else	//else !VPRO is true jam 13 JUL 94#if VWT 	// jca 9 Nov 93 {		walkFile->cFile(query,appFileTypeModel, appFileCreator,appFilterDescriptorWALK,TXTPF_MODEL); #if WINDOWS 		// on the mac, the files are the same type.  Not so under Windows(tm)!		walkFile->AddFType(appFileTypeModel, appFilterDescriptorVR); #endif // WINDOWS#elif VR		walkFile->cFile(query,appFileTypeVRModel, appFileCreator,appFilterDescriptorVR,TXTPF_MODEL); #if WINDOWS 		// on the mac, the files are the same type.  Not so under Windows(tm)! 		walkFile->AddFType(appFileTypeModel, appFilterDescriptorWALK);	 #endif // WINDOWS#endif // VWT jca 9 Nov 93 }#endif //VPRO jam 13 JUL 94 ]]]#if MACINTOSH		walkFile->SetName(title);#endif		walkFile->SetVolume(vRefNum);		}		result = Load(query);/* if( ( modelError == result ) || ( modelCancel == result ) ) */if(result) 		return(FALSE);							return(TRUE);	}voidWalkDocument::dDocument()	{		if(walkController)		walkController->dController();	walkController = NULL;	WalkDocumentStub::dDocument();	}	int gNextVRLib3D = 0;			// ABD MERGE14int gNextVRLib2D = 0;			// ABD MERGE14int gNextTextureLib = 0;		// ABD MERGE14TextureArray *gCurrentTextures;	// MERGE16TextureArray *gAllTextures;		// MERGE16TextureArray *gAllDocTextures;	// MERGE20V_Array *gTextureArrays;		// MERGE16TextureArray *gCustomPicts;		// MERGE24// ABD MERGE10 WILLIAMS 9/9/93 {#if VRV_Window*WalkDocument::GetVRLib()	{	V_Window	*theLib = NULL;		if (VRLibFlag)        {		if (currently_3d)			{			if (current_library_3d)	theLib = current_library_3d->libWindow;			}		else			{			if (current_library_2d)	theLib = current_library_2d->libWindow;			}		}	return(theLib);	}V_Window*WalkDocument::GetVRWalk()	{	return walkWindow;	}V_Window*WalkDocument::GetVRDesign()	{	return designWindow;	}	voidWalkDocument::OpenVRLib3D(int lib_num)	{	if (!current_library_3d && stub)		{		if (pds(stub)->current_library_3d)			{			current_library_3d = pds(stub)->current_library_3d;			current_library_3d->UninstallSuperDoc();			current_library_3d->InstallSuperDoc(this);			pds(stub)->current_library_3d = NULL;			current_3d_library_num = pds(stub)->current_3d_library_num;			lib_num = current_3d_library_num;			pds(stub)->current_3d_library_num = -1;			current_library_3d->vr_doc = this;		#if MACINTOSH			GetVRLib()->Hide();			GetVRLib()->Show();		#endif //MACINTOSH			currently_3d = TRUE;			}		}	WalkDocumentStub::OpenVRLib3D(lib_num);	}voidWalkDocument::OpenVRLib2D(int lib_num)		// MERGE15	{	if (!current_library_2d && stub)		{		if (pds(stub)->current_library_2d)			{			current_library_2d = pds(stub)->current_library_2d;			current_library_2d->UninstallSuperDoc();			current_library_2d->InstallSuperDoc(this);			pds(stub)->current_library_2d = NULL;			current_2d_library_num = pds(stub)->current_2d_library_num;			lib_num = current_2d_library_num;			pds(stub)->current_2d_library_num = -1;			current_library_2d->vr_doc = this;			currently_3d = TRUE;			}		else			WalkDocumentStub::OpenVRLib2D(lib_num);		}	else		WalkDocumentStub::OpenVRLib2D(lib_num);	}voidWalkDocument::OpenTextureLib(int lib_num)	// MERGE14	{	WalkDocumentStub::OpenTextureLib(lib_num);	}voidWalkDocument::InitLibs(int lib3d, int lib2d)		// MERGE15	{	WalkDocumentStub::InitLibs(lib3d, lib2d);	}voidWalkDocument::SwitchLibs(int to_2d)		// MERGE15	{	WalkDocumentStub::SwitchLibs(to_2d);	}#endif // VRvoidWalkDocument::TransferControl()	{#if !VR  // jca 16FEB94 transfer to the stub only if this is the last document	if(1==theSuper->ALength())#endif // !VR		TransferDocumentControl(stub);       	// jca 10 Oct 93	}// jca 16FEB94 moved out of VR section, so VWT Win can use the stub// (V_Document::CloseDocument transfers the MDI when appropriate,// using the appropriate TransferControl() routine to decide if this// time is appropriate)voidWalkDocument::CloseDocument()	{#if VR	extern TextureServer *gTextureServer; 	// MERGE20	int i;		// MERGE-DEL	extern TextureArray *gAllDocTextures;	// MERGE-DEL		if ((current_library_3d || current_library_2d) && stub)		{		if (! currently_3d)			{			SwitchLibs(FALSE);			currently_3d = TRUE;			}		pds(stub)->currently_3d = currently_3d;					if (current_library_3d)			{			pds(stub)->current_library_3d = current_library_3d;			pds(stub)->current_3d_library_num = current_3d_library_num;			current_library_3d->vr_doc = pds(stub);			current_library_3d->UninstallSuperDoc();			current_library_3d->InstallSuperDoc(stub);			}		if (current_library_2d)			{			pds(stub)->current_library_2d = current_library_2d;			pds(stub)->current_2d_library_num = current_2d_library_num;			current_library_2d->vr_doc = pds(stub);			current_library_2d->UninstallSuperDoc();			current_library_2d->InstallSuperDoc(stub);			}		VSendMessage(CLEAN_MENUS);		current_library_3d = NULL;		current_library_2d = NULL;		}	if (current_library_3d)		current_library_3d->CloseDocument();	if (current_library_2d)		current_library_2d->CloseDocument();	gTextureServer->RemoveDocTextures();	// MERGE20#endif // VR	V_Document::CloseDocument();#if VR	// with texture stuff we need to do several things:	// 1) remove the this-document-only textures from the gAllTextures list	// 2) delete all of the texture items in gAllDocTextures	// 3) delete all of the textures and texture types that are only in gAllDocTextures	// 4) set the length of gAllDocTexture to zero	// remove the texture items that are only in this document from the gAllTextures list	//gTextureServer->RemoveDocTextures();	// MERGE20	// MERGE-DEL [[[	// delete the texture items in gAllDocTextures -- dTextureItem also removes the texture	// item from its parent TextureArray, which is gAllTextures	if (gAllDocTextures)	{		// delete all the texture items that are in the document we are closing 		for ( i = gAllDocTextures->ALength()-1 ; i >= 0 ; i-- )		{		TextureItem *ti = NULL;			gAllDocTextures->Get(i, &ti);			if (ti) ti->dTextureItem();		// calls Remove from gAllTextures		}	}	// MERGE-DEL ]]]		// ¥¥¥Êdelete the textures here	// set the length of gAllDocTexture to zero	gAllDocTextures->SetLength(0);#endif	}// ABD MERGE4 WILLIAMS 9/9/93 }int 	WalkDocument::Load(int query) 	{	char str[256],oldTitle[256];	int err,result,loadOverFlag;		err = 0;	loadOverFlag = FALSE;		strcpy(oldTitle,title);		if(LOADOVER != query)		loadOverFlag = FALSE;	else		{		query = LOADAS;		loadOverFlag = TRUE;		}			walkFile->SetQuery(query,TXTGF_MODEL);		switch(query)		{		case LOAD: 			if(!Empty()&&Changed())				{				if(FALSE == QRevert(title)) return(FALSE);				LaunchController(toolCRTLWalk);				result = walkFile->Find();				if(result) result = modelCancel;				else result = IOFile(query);						}				else				result = modelCancel; 			break;						case IMPORT_FILE: 			break;					case LOADAS:			if(!Empty() || Changed()) 				{ LoadNew(LOADAS); return(FALSE); }		case LOADSTART: 			result = walkFile->Find();			if(result) result = modelCancel;			else result = IOFile(query);					break;						case NEW:		case INIT: 				default:			result = modelNone;			break;		}		switch(result)		{		case modelNone:			walkController->Activate(msgInit) ;			untitled = TRUE;			err = FALSE;			break;					case modelFine:			vRefNum=walkFile->GetVolume();/* DAS 11/12/90 */			walkController->Activate(msgInit) ;			err = FALSE;			break;				case modelToBig:			walkFile->GetFName(title);			sprintf(str,TXTW_LOADMEMERR,title);			AlertMessage(str);			SetTitle(oldTitle);			walkController->SetChange(FALSE);			untitled = TRUE;			err = TRUE;			break;		case modelError:			walkFile->GetFName(title);			sprintf(str,TXTW_LOADERR,title);			AlertMessage(str);			walkController->Activate(msgInit) ;			SetTitle(oldTitle);			walkController->SetChange(FALSE);			untitled = TRUE;			err = TRUE;			break;				case modelStationery:			walkController->Activate(msgInit) ;			SetTitle(TXT_UNTITLED);	// PRO-JAP			walkController->SetChange(FALSE);			untitled = TRUE;			err = FALSE;			break;					case modelReadOnly:		// BILBIL - read-only fix 11/29/93 {{{			walkController->Activate(msgInit) ;			untitled = TRUE;			err = FALSE;			break;				// BILBIL - read-only fix 11/29/93 }}}		case modelCancel:			SetTitle(oldTitle);			walkController->SetChange(FALSE);			untitled = TRUE;			if(loadOverFlag) err = FALSE;			else err = TRUE;			break;		}				return err;		}int WalkDocument::Save(int query) 	{	char oldTitle[256],str[256];	int 	err,result,wasUntitled;	char fn[256];				// ABD MERGE-TEXTURE 9/13/93	short vol;					// ABD MERGE-TEXTURE 9/13/93	char fname[256];			// ABD MERGE-TEXTURE 9/13/93// JAM 7-18-94 to help handle embedding/file refs for textures[[[#if VPRO	AppPreference *appPref;	TranslatorPreference	*transPref;#endif// JAM 7-18-94 to help handle embedding/file refs for textures]]]				strcpy(oldTitle,title);	wasUntitled = untitled;	err = FALSE;#if !SAVE_DISABLED  // jca 10FEB95 for AJ and VR-J	switch(query)		{		case SAVE: 			if(!Changed() && !Empty()) return(FALSE);			if(Untitled())query=SAVEAS;		case SAVEAS:		case SAVECOPYAS:		// JAM 7-18-94 to help handle embedding/file refs for textures[[[#if VPRO			appPref = walkController->GetPreference();			transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);			walkFile->SetEmbedTextures(transPref->GetEmbedTextures());#endif// JAM 7-18-94 to help handle embedding/file refs for textures]]]			walkFile->SetQuery(query,TXTPF_MODEL);#if VPRO && !SPECIAL_EDITION		// SPECIAL EDITION VRML  // GJR 07/12/95			walkFile->use_radio_button_save = TRUE;	// MERGE-GOURAUD-PRO#else  // keep it off			walkFile->use_radio_button_save = FALSE;	// MERGE-GOURAUD-PRO#endif			result = walkFile->Find();#if VPRO			walkFile->use_radio_button_save = FALSE;	// MERGE-GOURAUD-PRO#endif// JAM 7-18-94 to help handle embedding/file refs for textures[[[#if VPRO//			appPref = walkController->GetPreference();//			transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);			transPref->SetEmbedTextures(walkFile->GetEmbedTextures());#endif// JAM 7-18-94 to help handle embedding/file refs for textures]]]			if(result) result = modelCancel;			else result = IOFile(query);					break;			}				switch(result)		{		case modelFine:		case modelReadOnly:		// BILBIL - read-only fix 11/29/93			if(SAVECOPYAS!=query)				walkController->SetChange(FALSE);			err = FALSE;			break;						case modelError:			sprintf(str,TXTW_SAVEERR,title);			AlertMessage(str);					default:			err = TRUE;			if((SAVECOPYAS != query) && !wasUntitled)	// jca 5/2/93  Only name from file if it had a name (may only be valid for the windows version)				{				vRefNum=walkFile->GetVolume();/* DAS 11/12/90 */				walkFile->GetFName(oldTitle);				}//			SetTitle(oldTitle);			if(wasUntitled)untitled=TRUE;			break;		}#endif //!SAVE_DISABLED  // jca 10FEB95 for AJ and VR-J	return(err);		}					intWalkDocument::IOFile(int	query)	{	V_File *hold;	char 	str[256],text[256];	int		err,result,extLength,sequence;    long	total;	err = 0;	result = 0;	if(SAVE == query)		{		char	fName[256],extension[256];		hold = new(V_File);#if VPRO  //VPRO jam 13 JUL 94 ]]]  #if !SPECIAL_EDITION                // Special Edition, VRML	// GJR 07/12/95		hold->cFile(REFERENCE,appFileTypeTEMP,appFileCreator,appFilterDescriptorVPRO,TXTPF_MODEL);    #if WINDOWS 		// on the mac, the files are the same type.  Not so under Windows(tm)!		hold->AddFType(appFileTypeTEMP, appFilterDescriptorVR);    #endif // WINDOWS  #else  // SPECIAL EDITION, VRML. Only do its own filetype.	#if !VRML_ANCHOR		hold->cFile(REFERENCE,appFileTypeTEMP,appFileCreator,appFilterDescriptorWALK,TXTPF_MODEL);	#else		hold->cFile(REFERENCE,appFileTypeTEMP,appFileCreator,appFilterDescriptorVWTVRML,TXTPF_MODEL);	#endif  #endif#else	//else !VPRO is true jam 13 JUL 94		hold->cFile(REFERENCE,appFileTypeTEMP,appFileCreator,appFilterDescriptorWALK,TXTPF_MODEL);#endif		hold->SetVolume(walkFile->GetVolume());/* jca */		walkFile->GetFName(str);		strcpy(extension,appFileExtensionTEMP);    		sequence=1;		sprintf(fName,"%s.%s",str,extension);		//JAM 1-27-95 [[[		//if name + ".temp" is too long, truncate name so		//that name + ".temp" isn't too long.  Uses str2 just in case		//str is used elsewhere.		#if MACINTOSH		if(strlen(fName) > MAXFILENAMELENGTH)		{			char 	str2[256];			strcpy(str2,str);			str2[31-strlen(extension)-1] = '\0';			sprintf(fName,"%s.%s",str2,extension);				}		#endif		//JAM 1-27-95 ]]]		hold->SetName(fName);				while(TRUE)			{/* jca			extLength = strlen(extension)+1;			if((strlen(str)+extLength)>MAX_FILENAME_LENGTH)				str[MAX_FILENAME_LENGTH-extLength]=0;				sprintf(fName,"%s.%s",str,extension);			hold->SetFName(fName);           */			if((err = hold->FVerify()) != 0)				break;//#if WINDOWS		// jca 25 Oct 93	It's not just for Windows anymore!			sprintf(fName,"%s.%s",str,extension);			hold->SetName(fName);			sprintf(extension, "%d", sequence++);			hold->AppendFName(extension);//#endif //WINDOWS	// jca 25 Oct 93	It's not just for Windows anymore!/* jca			sprintf(extension, "%s%d", appFileExtensionTEMP, sequence++); */ 			}		if(err != fileNotFoundErr)			return(modelError); /* ick; shouldn't return from middle here */		else if(hold->Copy(walkFile) != 0)			{			hold->dFile();			return(modelError); /* ick; shouldn't return from middle here */			}		}	walkFile->Open(TRUE);	 if((walkFile->ReadOnly())&&(SAVEAS != query))		// BILBIL - read-only fix 11/29/93		{	 	char str[256], file_name[256];		result = modelReadOnly;		// BILBIL - read-only fix 11/29/93		walkFile->GetFName(file_name);		sprintf(str, TXTW_READONLY, file_name);		AlertMessage(str);		}	 if(walkFile->Stationery())		result = modelStationery;			walkFile->GetFName(str);		SetTitle(str);	if (walkFile->IODirection() == DATA_IN)		{		sprintf(text,TXT_METREAD,str);		walkFile->IOLength(&total);		}	else		{		sprintf(text,TXT_METWRITE,str);		total = walkController->TreeSize(TRUE);		}	MeterCreate();	MeterTitle(TXT_APPNAME);	MeterSetText(text);	MeterSetTotal(total);	MeterSetCount(0);    MeterStart();	err = walkController->IO(walkFile);#if MACINTOSH//	walkFile->IOSetDirection(DATA_OUT);	walkFile->create = appFileCreator;#endif //MACINTOSH    MeterStop();	walkFile->Close();	switch(err)		{		case 0:			if(result!=modelStationery && result!=modelReadOnly)				result = modelFine;		// BILBIL - read-only fix 11/29/93			break;		case -1: result = modelError; break;		case -2: result = modelCancel; break;		case -3: result = modelToBig; break;		default: result = modelError; break;		}	if(SAVE == query)		{		if(modelFine != result)			{			walkFile->GetFName(str);			walkFile->Delete();			walkFile->dFile();			hold->Rename(str);			walkFile = hold;			}		else			{			hold->Delete();			hold->dFile();			}		}	return(result);	}/* DWE ... MJU ... */intWalkDocument::Import(int importType,int format)	{	TranslateDialog *translateDialog;	AppPreference *appPref;	TranslatorPreference	*transPref;	V_File		*file;							// merge SE, vrmadness		// GJR 7/4/95#if !SPECIAL_EDITION 	// jca 27AUG94 vrmadness	QuickTime 	*theQTFile;	V_AVIFile	*theAVIFile;#endif // !SPECIAL_EDITION 	// jca 27AUG94 vrmadness	int			result,err,query,quickSnap;	long		type;		if(!walkController) return(FALSE);					switch(importType)		{							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness		// jca 17 Sept 93.  No imports into VR {		case import:			result = WalkDocumentStub::Import(importType,format);			break;		// jca 17 Sept 93.  No place/impors into VR {#endif // VWT				case export:			appPref = walkController->GetPreference();			transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);						switch(format)				{							// merge SE, vrmadness		// GJR 7/4/95#if !SPECIAL_EDITION // jca 27AUG94 vrmadness				case formatSameSnap:					format = transPref->lastTranslator;					if(quickSnapNumber)						{						query = SAVE;						result = TRUE;						}					else						{						translateDialog = new(TranslateDialog);						result = translateDialog->cTranslateDialog(walkController,format,importType);						if(result) query = SAVEAS;						}					break;				case formatPlayer:					result = TRUE;                    query = SAVEAS;					break;                #if VRML_ANCHOR // ABD				case formatVRML:					// PRO25 added this stuff here					translateDialog = new(TranslateDialog);					result = translateDialog->cTranslateDialog(walkController,format,importType);					if(result) 						query = SAVEAS;					break;                #endif // VRML_ANCHOR				case formatPICS:				case formatQuickTime:				case formatFLIC:				case formatAVI:					transPref->startFrame = 0;					transPref->endFrame = walkController->observer->path->ALength()-1;#endif // !SPECIAL_EDITION // jca 27AUG94 vrmadness				default:					translateDialog = new(TranslateDialog);					result = translateDialog->cTranslateDialog(walkController,format,importType);					if(result)						{						query = SAVECOPYAS;						query = SAVEAS;						quickSnapNumber = 0;						}					break;				}						transPref->lastTranslator = format;								if(result) 				{				quickSnap = quickSnapNumber;				switch(format)					{							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness					// jca 17 Sept 93.  None of these are in VR {					case formatClarisCAD:							file=new(V_File);						file->cFile(query,appFileTypeCLARISCAD,appFileCreatorCLARISCAD,appFilterDescriptorCCAD,TXTPF_CCAD);						Export2D(file,formatClarisCAD,quickSnap);						file->dFile();						break;						case formatMacDraw:						file = new(V_File);						file->cFile(query,appFileTypeMDII,appFileCreatorMDII,appFilterDescriptorMDII,TXTPF_MDII);						Export2D(file,formatMacDraw,quickSnap);						file->dFile();							break;											case format3DDXF:							file = new(V_File);						file->cFile(query,appFileTypeDXF,appFileCreatorDXF,appFilterDescriptorDXF,TXTPF_DXF3D);						Export3D(file,format3DDXF);						file->dFile();							break;											case format2DDXF:							file = new(V_File);						file->cFile(query,appFileTypeDXF,appFileCreatorDXF,appFilterDescriptorDXF,TXTPF_DXF2D);						Export2D(file,format2DDXF,quickSnap);						file->dFile();							break;					case formatVoyager:						file = new(V_File);						file->cFile(query,appFileTypeAPPL,appFileCreatorVoyager,appFilterDescriptorVOYAGER,TXTPF_VOYAGER);						ExportVoyager(file);						file->dFile();						break;// MERGE-GOURAUD-PRO-11 [[[					case formatPlayer:						{						file = new(V_File);						file->cFile(query,appFileTypePlayerModel,appFileCreatorPlayer,appFilterDescriptorPLAYER,TXTPF_PLAYER);						ExportPlayer(file);						file->dFile();						}						break;					case formatEPS:						type = (transPref->EPSFDevice == EPSForTheMac ?							appFileTypeEPSF : appFileTypeEPSP);						file=new(V_File);						file->cFile(query,type, appFileCreatorEPSF,appFilterDescriptorEPSF,TXTPF_EPS);						Export2D(file,formatEPS,quickSnap);						file->dFile();						break;						case formatIllustrator:						type = (transPref->EPSFDevice == EPSForTheMac ?							appFileTypeIllusMac : appFileTypeIllusWin);						file=new(V_File);						file->cFile(query,type, appFileCreatorILLUS,appFilterDescriptorILLUS,TXTPF_ILLUS);						Export2D(file,formatIllustrator,quickSnap);						file->dFile();						break;					case formatTIFF:						file=new(V_File);						file->cFile(query, appFileTypeTIFF,appFileCreatorTIFF,appFilterDescriptorTIFF,TXTPF_TIFF);						Export2D(file,formatTIFF,quickSnap);						file->dFile();							break;					// jca 17 Sept 93.  }#endif // VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness				#if VRML_ANCHOR				// VRML-ABD 23JUN95					case formatVRML:							file = new(V_File);						file->cFile(query,appFileTypeVRML,appFileCreatorVRML,appFilterDescriptorVRML,TXTPF_VRML);						ExportVRML(file);						file->dFile();							break;				#endif // VRML_ANCHOR					case formatPICT:						file=new(V_File);						file->cFile(query,appFileTypePICT,appFileCreatorPICT,appFilterDescriptorPICT,TXTPF_PICT);						Export2D(file,formatPICT,quickSnap);						file->dFile();							break;						case formatBMP:						file=new(V_File);						file->cFile(query,appFileTypeBMP,appFileCreatorBMP,appFilterDescriptorBMP,TXTPF_BMP);						Export2D(file,formatBMP,quickSnap);						file->dFile();							break;							// merge SE, vrmadness		// GJR 7/4/95#if !SPECIAL_EDITION 	// jca 27AUG94 vrmadness					case formatPICS:						file=new(V_File);						file->cFile(query,appFileTypePICS,appFileCreatorPICS,appFilterDescriptorPICS,TXTPF_PICS);						Export2D(file,formatPICS,quickSnap);						file->dFile();							break;						case formatQuickTime:						theQTFile=new(QuickTime);						theQTFile->cQuickTime(query,appFileTypeQuickTime,appFileCreatorQuickTime,appFilterDescriptorQUICKTIME,TXTPF_QUICTIME);						Export2D(theQTFile,formatQuickTime,quickSnap);						theQTFile->dQuickTime();						break;					case formatFLIC:						file=new(V_File);						/*						FLI files are 320x200 pixels.  This is the only						size an FLI file can be (it's just under 65K, so it						fits in a single segment).  FLC files, on the other hand,						can be anything -- except 320 x 200.  So do the right						thing, extension-wise.						*/                        // jca 14 Dec 93 {						if(transPref->screenSize==screenCustom)							{    // output rect is only set if this is a custom screen							if ((transPref->outputRect.right == 320) && (transPref->outputRect.bottom == 200))								file->cFile(query,appFileTypeFLI,appFileCreatorFLI,appFilterDescriptorFLI,TXTPF_FLIC);							else								file->cFile(query,appFileTypeFLC,appFileCreatorFLC,appFilterDescriptorFLC,TXTPF_FLIC);							}						else							{  // otherwise, get the scree size and use that							Point p;							Controller *flcCtrl;							V_Window *flcwindow;							// this code borrowed from dlogtran.cp, which has to do the							// same kind of stuff to figure out what the size of the                            // snapshot is, whether it's a custom, and so on.							flcCtrl = walkController->GetFrontController();   // get the frontmost (active) controller							flcwindow = flcCtrl->GetWindow(flcCtrl->GetType()); // get the window from that controller							ScreenSize(transPref->screenSize,&p,flcwindow);   // ask for the screen extents							if ((p.h == 320) && (p.v == 200))								file->cFile(query,appFileTypeFLI,appFileCreatorFLI,appFilterDescriptorFLI,TXTPF_FLIC);							else								file->cFile(query,appFileTypeFLC,appFileCreatorFLC,appFilterDescriptorFLC,TXTPF_FLIC);							}                        // jca 14 Dec 93 }						Export2D(file,formatFLIC,quickSnap);						file->dFile();							break;					case formatAVI:      						theAVIFile=new(V_AVIFile);						theAVIFile->cAVIFile(query,appFileTypeAVI,appFileCreatorAVI,appFilterDescriptorAVI,TXTPF_AVI);						Export2D(theAVIFile,formatAVI,quickSnap);						theAVIFile->dFile();						break;#endif // !SPECIAL_EDITION // jca 27AUG94 vrmadness					}				}			break;									// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness		// jca 17 Sept 93.  No place/impors into VR {		case place:		case trace:			file=new(V_File);			switch(format)				{				case formatClarisCAD:						file->cFile(LOADAS,appFileTypeCLARISCAD,appFileCreatorCLARISCAD,appFilterDescriptorCCAD,TXTGF_CCAD);					break;				case formatPICT:					file->cFile(LOADAS,appFileTypePICT,appFileCreatorPICT,appFilterDescriptorPICT,TXTGF_PICT);					break;				case formatBMP:					file->cFile(LOADAS,appFileTypeBMP,appFileCreatorBMP,appFilterDescriptorBMP,TXTGF_BMP);					file->AddFType(appFileTypeBMP,appFilterDescriptorDIB);					break;				case formatTIFF:					file->cFile(LOADAS,appFileTypeTIFF,appFileCreatorTIFF,appFilterDescriptorTIFF,TXTGF_TIFF);					break;				case formatMacDraw:					file->cFile(LOADAS,appFileTypeMDII,appFileCreatorMDII,appFilterDescriptorMDII,TXTGF_MDII);					break;				case format2DDXF:					file->cFile(LOADAS,appFileTypeDXF,appFileCreatorDXF,appFilterDescriptorDXF,TXTGF_DXF2D);					break;				}                /* do the import */			if( Import2D(file,format) )				file->dFile();			break;		// jca 17 Sept 93.  }#endif // VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness		}					return(result);	}		intWalkDocument::Import2D(V_File *file,int format)	{	CAVWalkController	*pCtrl;	Point3DFFixed inputVector;	AlertDialog	*placeAlert;	ScoreRecord	scoreRec;	char	str[256],objStr[256];	int	result,err;			result = file->Find();	if(result) 		err = modelCancel;	else		{			err = 0;		scoreRec.traceRec.numUnusable = 0;		pCtrl = pwc(walkController);		inputVector = pCtrl->GetViewVector();		pCtrl->Import(inputVector,file,&scoreRec);						if(scoreRec.traceRec.numUnusable)			{			if(scoreRec.traceRec.numUnusable!=1)strcpy(objStr,"Object"); else strcpy(objStr,"Objects");			sprintf(str,"%i %s Ignored",scoreRec.traceRec.numUnusable);			AlertMessage(str);			}		}					return err;	}#define METER_COUNT 0x01#define METER_TITLE 0x02intWalkDocument::Export2D(V_File *file,int format,int quickSnap)	{	AppPreference *appPref;	TranslatorPreference	*transPref;	Point3DFFixed importVector;	char str[256],extension[256],snapNum[256],fileName[256],countStr[256],*numStr,*token;	int		result,length,extLength,lineTerm,total,doMeter;	#if !VR		// MERGE-VR-FIX	ClarisFrame theFrameType;	ClarisFill theFillType;	#endif // !VR	// MERGE-VR-FIX							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness// jca 17 Sept 93 {	Export_DXF2D *exportDXF2D;// BULLSHIT	Export_MacDrawII *exportMDII;	Export_ClarisCAD	*exportCCAD;// jca 17 Sept 93 }#endif // VWT	result = 0;	doMeter = 0;		appPref = walkController->GetPreference();	transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);	extension[0] = '\0';      /* jca */#if MACINTOSH	switch(format)		{		case formatPICT: strcpy(extension, TXTEXT_PICT); break;		case formatBMP: strcpy(extension, TXTEXT_BMP); break;#if !SPECIAL_EDITION         	// merge SE, vrmadness		// GJR 7/4/95		case formatQuickTime: strcpy(extension, TXTEXT_QUICTIME); break;		case formatTIFF: strcpy(extension, TXTEXT_TIFF); break;		case formatFLIC:if ((transPref->outputRect.right == 320) && (transPref->outputRect.bottom == 200))			strcpy(extension, TXTEXT_FLI); else strcpy(extension, TXTEXT_FLC); break;		case formatPICS: strcpy(extension, TXTEXT_PICS); break;		case formatAVI: strcpy(extension, TXTEXT_AVI); break;  #endif //!SPECIAL_EDITION		// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness		// jca 17 Sept 93.  {		case formatClarisCAD: strcpy(extension, TXTEXT_CCAD); break;		case formatMacDraw: strcpy(extension, TXTEXT_MDII); break;		case format2DDXF: strcpy(extension, TXTEXT_DXF); break;		case formatEPS: strcpy(extension, TXTEXT_EPS); break;		case formatIllustrator: strcpy(extension, TXTEXT_ILLUS); break;		// jca 17 Sept 93.  }#endif // VWT		}#endif		if(quickSnap)		{		sprintf(extension,"-%i",quickSnap);        strcpy(str, quickName);/*jca	length = strlen(quickName);		extLength = strlen(extension)+1;		if((length+extLength)>MAX_FILENAME_LENGTH)			quickName[MAX_FILENAME_LENGTH-extLength]=0;		sprintf(str,"%s.%s",quickName,extension);*/		}	else		{		if(Untitled())        	{			strcpy(str, TXTD_UNTITLED);			length = strlen(TXTD_UNTITLED);			}		else			{			strcpy(str,title);			length = strlen(title);#if MACINTOSH/* jca			extLength = strlen(extension)+1;			if((length+extLength)>MAX_FILENAME_LENGTH)				str[MAX_FILENAME_LENGTH-extLength]=0;			strcat(str,".");			strcat(str,extension);*/#endif			}		}		#if MACINTOSH	file->SetName(str);#elif WINDOWS	if (!(Untitled()))		file->SetName(str);#endif    file->AppendFName(extension);  /* jca */	// MERGE28 ABD moved to here so mac/win same	file->SetVolume(quickVolume);	result = file->Find();		if(!result)		{	#if WINDOWS		file->GetName(quickName);#elif MACINTOSH		file->GetFName(quickName);#endif //WINDOWS		quickSnapNumber = GetTrailerNumber(quickName)+1;		quickVolume = file->GetVolume();		switch(format)			{#if !SPECIAL_EDITION			// merge SE, vrmadness		// GJR 7/4/95			case formatQuickTime:			case formatFLIC:			case formatAVI:			case formatPICS:				total =100;				sprintf(countStr,TXTM_FRAMES);				doMeter = METER_TITLE|METER_COUNT;				break;#endif  //!SPECIAL_EDITION // jca 27AUG94 vrmadness							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness			// jca 17 Sept 93.  {			case formatClarisCAD:			case formatMacDraw:			case format2DDXF:				total = walkController->TreeSize(FALSE);				sprintf(countStr,TXTM_OBJECTS);				doMeter = METER_TITLE;				break;			// jca 17 Sept 93.  }#endif // VWT			case formatPICT:							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness			// jca 17 Sept 93.  {			case formatEPS:			case formatIllustrator:			case formatTIFF:			// jca 17 Sept 93 	}#endif // VWT				total = -1;				doMeter = METER_TITLE;				break;			}if(doMeter)	{				file->GetFName(fileName);	MeterCreate();	MeterTitle(TXT_APPNAME);	sprintf(str,TXT_METWRITE,fileName);	MeterSetText(str);	MeterSetTotal(total);	if(doMeter&METER_COUNT)		{		MeterSetCount(0);		MeterSetCountTitle(countStr);		}	MeterStart();	}		switch(format)			{							// merge SE, vrmadness		// GJR 7/4/95#if !SPECIAL_EDITION 	// jca 27AUG94 vrmadness			case formatQuickTime:				((QuickTime*)file)->OpenMovie(TRUE);				result = walkController->ExportContents(file,formatQuickTime);				((QuickTime*)file)->CloseMovie();				break;							case formatPICS:				file->OpenResource(TRUE);				result = walkController->ExportContents(file,formatPICS);				file->CloseResource();				break;							case formatFLIC:				file->Open(TRUE);				result = walkController->ExportContents(file,formatFLIC);				file->Close();				break;			case formatAVI:				((V_AVIFile*)file)->Open(TRUE);			 	result = walkController->ExportContents(file,formatAVI);				((V_AVIFile*)file)->Close();				break;#endif // !SPECIAL_EDITION 	// jca 27AUG94 vrmadness			case formatPICT:				file->Open(TRUE);				result = walkController->ExportContents(file,formatPICT);				file->Close();				break;					case formatBMP:				file->Open(TRUE);				result = walkController->ExportContents(file,formatBMP);				file->Close();				break;							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness			// jca 17 Sept 93.  {			case formatTIFF:				file->Open(TRUE);				result = walkController->ExportContents(file,formatTIFF);				file->Close();				break;			case formatEPS:				file->Open(TRUE);				result = walkController->ExportContents(file,formatEPS);				file->Close();				break;					case formatIllustrator:				file->Open(TRUE);				result = walkController->ExportContents(file,formatIllustrator);				file->Close();				break;					case formatClarisCAD:			#if 0				importVector = transPref->exportView;				exportCCAD = new(Export_ClarisCAD);				exportCCAD->cExport();				switch(transPref->CLARISFillType)					{					case CLARISFillNone: theFillType = fillNone; break;					case CLARISFillWhite: theFillType = fillWhite; break;					case CLARISFillObject:					default: theFillType = fillObject; break;					}				if(transPref->frameBlack)theFrameType = frameBlack;				else theFrameType = frameObject;								file->Open(TRUE);				exportCCAD->Options(theFillType,theFrameType,importVector);				exportCCAD->Open(file, exportInch, 2.54);						result = pwc(walkController)->Export(exportCCAD);					exportCCAD->Close();				exportCCAD->dExport();								file->Close();			#endif				break;			case formatMacDraw:			#if 0				importVector = transPref->exportView;				file->Open(TRUE);				exportMDII = new(Export_MacDrawII);				exportMDII->cExport();				switch(transPref->CLARISFillType)					{					case CLARISFillNone: theFillType = fillNone; break;					case CLARISFillWhite: theFillType = fillWhite; break;					case CLARISFillObject:					default: theFillType = fillObject; break;					}				if(transPref->frameBlack)theFrameType = frameBlack;				else theFrameType = frameObject;				exportMDII->Options(theFillType,theFrameType,importVector);				exportMDII->Open(file, exportInch, 2.54);					result = pwc(walkController)->Export(exportMDII);					exportMDII->Close();				exportMDII->dExport();				file->Close();			#endif				break;							case format2DDXF:				importVector = transPref->exportView;				file->Open(TRUE);				exportDXF2D = new(Export_DXF2D);				exportDXF2D->cExport();				switch(transPref->exportLineMode)					{					case lineTermMac: lineTerm = mac_os; break;					case lineTermUNIX:lineTerm = unix; break;					case lineTermPC: 					default: lineTerm = ms_dos; break;					}				exportDXF2D->Options2D(lineTerm,transPref->DXFobjColor ? by_object : by_layer,importVector);				exportDXF2D->Open(file, exportInch, 2.54);					result = pwc(walkController)->Export(exportDXF2D);					exportDXF2D->Close();				exportDXF2D->dExport();				file->Close();				break;			// jca 17 Sept 93	}	#endif // VWT && !SPECIAL_EDITION // jca 27AUG94 vrmadness			default:				break;			}		}		if(doMeter)	MeterStop();			return(result);	}							intWalkDocument::Export3D(V_File *file,int format)	{	AppPreference *appPref;	TranslatorPreference	*transPref;	char str[256];	int	result,lineTerm,geomFlag,length,extLength,total;							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION 	// jca 27AUG94 vrmadness	Export_DXF3D *export;#endif // VWT	result = 0;							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION 	// jca 27AUG94 vrmadness	// jca 17 Sept 93.  {	appPref = walkController->GetPreference();	transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);		if(format == format3DDXF)		{		if(Untitled())        	{			strcpy(str, TXTD_UNTITLED);			length = strlen(TXTD_UNTITLED);			}		else			{			strcpy(str,title);			length = strlen(title);#if MACINTOSH/* jca			extLength = strlen(TXTEXT_DXF)+1;			if((length+extLength)>MAX_FILENAME_LENGTH)				str[MAX_FILENAME_LENGTH-extLength]=0;			strcat(str,".");			strcat(str,TXTEXT_DXF);			file->AppendFName(TXTEXT_DXF);*/#endif			}#if MACINTOSH		file->SetName(str);#elif WINDOWS		if (!(Untitled()))			file->SetName(str);#endif		result = file->Find();			if(!result)			{			if(0==file->Open(TRUE))				{				export = new(Export_DXF3D);				export->cExport();				switch(transPref->exportLineMode)					{					case lineTermMac: lineTerm = mac_os; break;					case lineTermUNIX:lineTerm = unix; break;					case lineTermPC: 					default: lineTerm = ms_dos; break;					}				if(exportLine == transPref->DXFsurf)geomFlag = poly3d;				else geomFlag = face3d;				export->Options3D(lineTerm,transPref->DXFobjColor ? by_object : by_layer,					geomFlag,transPref->DXFextr ? TRUE : FALSE);				export->Open(file, exportInch, 2.54);	file->GetFName(fileName);	MeterCreate();	MeterTitle(TXT_APPNAME);	sprintf(str,TXT_METWRITE,fileName);	MeterSetText(str);	total = walkController->TreeSize(FALSE);	MeterSetTotal(total);	MeterStart();					result = pwc(walkController)->Export(export);	MeterStop();					export->Close();				export->dExport();				}			file->Close();			}		}	// jca 17 Sept 93 }#endif	return(result);	}int gReadingEncryptedFile = FALSE;		// PRO-22intWalkDocument::ExportVoyager(V_File *file)	{#if VWT	AppPreference *appPref;	TranslatorPreference	*transPref;	char str[256];	int err,length,extLength;	int cancel = FALSE, created = FALSE;#ifdef JOEBOB /* use this on the Mac to convert Voyager App to Voyager Doc */{V_File *vApp;V_File *vDoc;vApp = new(V_File);vApp->cFile(LOADAS,appFileTypeAPPL,appFileCreatorVoyager,TXT_VOYAGER_APP);	// PRO-JAPvApp->Find();vApp->SetFork(RESOURCE_FORK);vDoc = new(V_File);vDoc->cFile(SAVEAS,appFileTypeVoyager,appFileCreator,TXT_VOYAGER_DATA);	// PRO-JAPvDoc->Find();vDoc->Copy(vApp);vDoc->dFile();vApp->dFile();return 0;}#endif //JOEBOB /* */	err = 0;#if MACINTOSH	appPref = walkController->GetPreference();	transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);	if(Untitled())    	{		strcpy(str, TXTD_UNTITLED);        length = strlen(TXTD_UNTITLED);        }	else		{		strcpy(str,title);		length = strlen(title);#if MACINTOSH/* jca		extLength = strlen(TXTEXT_VOYAGER)+1;		if((length+extLength)>MAX_FILENAME_LENGTH)			str[MAX_FILENAME_LENGTH-extLength]=0; 		strcat(str,".");		strcat(str,TXTEXT_VOYAGER); */#endif		}	file->SetName(str);	/* jca */#if WINDOWS	file->AppendFName(TXTEXT_VOYAGER);#endif //WINDOWS	err = file->Find();	if(!err)		{		VoyagerFile *vFile;		char text[256], textPlus[256];		long *sizePtr, partition;		char **size;		long vLength;		file->GetFName(str);		sprintf(text,TXT_METWRITE,str);		strcpy(textPlus, text);		strcat(textPlus, TXT_METCODE);		MeterCreate();		MeterTitle(TXT_APPNAME);		MeterSetText(textPlus);		MeterSetTotal(1);		MeterSetCount(0);		MeterStart();		vFile = new(VoyagerFile);		vFile->cVoyagerFile();		err = vFile->FindVoyager();		if (!err)			{			vFile->Open(FALSE);			err = vFile->IOLength(&vLength);			if (!err) MeterSetTotal(vLength);			vFile->Close();			file->SetFork(RESOURCE_FORK);			file->FinderFlags(TRUE);			err = file->Copy(vFile);			file->SetFork(DATA_FORK);			if (err == -2) cancel = TRUE;			if (!err) created = TRUE;			}		vFile->dFile();		if (!err)			{			strcpy(textPlus, text);#if WINDOWS			strcat(textPlus, TXT_METDATA);#endif //WINDOWS			MeterSetText(textPlus);			MeterSetTotal(walkController->TreeSize(TRUE));			MeterSetCount(0);			MeterUpdate(0);			file->Open(FALSE);            gReadingEncryptedFile = TRUE;   // PRO-22			file->SetCryptOn();			err = walkController->IO(file);			file->SetCryptOff();            gReadingEncryptedFile = FALSE;	// PRO-22			file->Close();			if (err == -2) cancel = TRUE;			}		if (!err && transPref->pictFile != NULL)			transPref->VerifyPictFile();/*BUGBUG		if (!err && transPref->creditType == creditForm)			{			V_Picture *pict;			CreditsPreview *credits;			Rect r;			strcpy(textPlus, text);			strcat(textPlus, TXT_METCREDITS);			MeterSetText(textPlus);			r.top = 0; r.bottom = VMax;			r.left = 0; r.right = VMax;						credits = new(CreditsPreview);			credits->cCreditsPreview(&r, NULL, transPref->text, FALSE);			r.right -= r.left; r.left = 0;			r.bottom -= r.top; r.top = 0;			pict = new(V_Picture);			pict->cPicture(TRUE);			pict->PutRect(&r);			pict->SetDepth(0);			err = credits->VOutput(pict);			if (!err) err = file->OpenResource(FALSE);			if (!err)				{				err = pict->IOResource(file, RSRC_PICT_VOYAGERCREDIT, NULL);				file->CloseResource();				}			pict->dPicture();			credits->Delete();			}		else if (!err && transPref->creditType == creditPICT)			{			V_Picture *pict;			strcpy(textPlus, text);			strcat(textPlus, TXT_METCREDITS);			MeterSetText(textPlus);			pict = new(V_Picture);			pict->cPicture(TRUE);			err = transPref->pictFile->Find();			if (!err) err = transPref->pictFile->Open(FALSE);			if (!err)				{				err = pict->IOPictFile(transPref->pictFile);				transPref->pictFile->Close();				}			if (!err) err = file->OpenResource(FALSE);			if (!err)				{				err = pict->IOResource(file, RSRC_PICT_VOYAGERCREDIT, NULL);				file->CloseResource();				}			pict->dPicture();			}*/		if (!err) err = file->IOSetDirection(DATA_IN);		if (!err) err = file->OpenResource(FALSE);		if (!err)			{			err = file->IOResource(&size, 'SIZE', -1, NULL);			file->CloseResource();			}		if (!err && size != NULL)			{			if (GetHandleSize(size) >= 10)				{				partition = walkController->VoyagerPartition();					sizePtr = (long *)(*size + 2);				*sizePtr++ = partition;				*sizePtr = partition;							err = file->IOSetDirection(DATA_OUT);				if (!err) err = file->OpenResource(FALSE);				if (!err)					{					err = file->VRemoveResource('SIZE', -1);					if (!err) err = file->IOResource(&size, 'SIZE', -1, NULL);					file->CloseResource();					}				}			DisposHandle(size);			}		MeterStop();		if (err && created)			file->Delete();		if (err && !cancel)			{			char fileName[256];			file->GetFName(fileName);			sprintf(str,TXTW_SAVEERR,fileName);			AlertMessage(str);			}		}#endif //MACINTOSH	return(err);#else	return(-1); // Voyager should not be in VR#endif //VWT	}// MERGE-GOURAUD-PRO-11 [[[intWalkDocument::ExportPlayer(V_File *file)	{#if VWT	AppPreference			*appPref;	TranslatorPreference	*transPref;	char					str[256];	int						err = 0, length, extLength;	int						cancel = FALSE, created = FALSE;	appPref = walkController->GetPreference();	transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);	strcpy(str, TXTD_UNTITLED);    length = strlen(TXTD_UNTITLED);	file->SetName(str);	err = file->Find();	if(err)		cancel = TRUE; 	// because the Find method polices invalid filenames and such jca 20APR95    else		{		char text[256], textPlus[256];		long *sizePtr, partition;		char **size;		long vLength;		file->GetFName(str);		sprintf(text, TXT_METWRITE, str);		strcpy(textPlus, text);		strcat(textPlus, TXT_METCODE);		MeterCreate();		MeterTitle(TXT_APPNAME);		MeterSetText(textPlus);		strcpy(textPlus, text);#if WINDOWS		strcat(textPlus, TXT_METDATA);#endif //WINDOWS		MeterSetText(textPlus);		MeterSetTotal(walkController->TreeSize(TRUE));		MeterSetCount(0);		MeterStart();		MeterUpdate(0);		file->Open(TRUE);		file->SetCryptOn();		err = walkController->IO(file);		file->SetCryptOff();		file->Close();		MeterStop();		if (err == -2) cancel = TRUE;		}	if (err && created)		file->dFile();	if (err && !cancel)		{		char fileName[256];		file->GetFName(fileName);		sprintf(str, TXTW_SAVEERR, fileName);		AlertMessage(str);		}	return(err);#else	return(-1); // VPlayer should not be in VR#endif //VWT}// MERGE-GOURAUD-PRO-11 ]]]#if VRML_ANCHOR// DAS VRML 95.03.24 BEGINintWalkDocument::ExportVRML(V_File *file)	{#if VWT	AppPreference			*appPref;	TranslatorPreference	*transPref;	char					str[256];	int						err = 0, length, extLength;	int						cancel = FALSE, created = FALSE;	Export_VRML *export;		appPref = walkController->GetPreference();	transPref = (TranslatorPreference*)appPref->GetPreference(preferTranslator);	strcpy(str, TXTD_UNTITLED);    length = strlen(TXTD_UNTITLED);	file->SetName(str);	err = file->Find();	if(err)					// ABD-VRML3		cancel = TRUE; 		// ABD-VRML3	else		{		char text[256], textPlus[256];		long *sizePtr, partition;		char **size;		long vLength;		file->GetFName(str);		sprintf(text, TXT_METWRITE, str);		strcpy(textPlus, text);		strcat(textPlus, TXT_METCODE);		MeterCreate();		MeterTitle(TXT_APPNAME);		MeterSetText(textPlus);		strcpy(textPlus, text);#if WINDOWS		strcat(textPlus, TXT_METDATA);#endif //WINDOWS		MeterSetText(textPlus);		MeterSetTotal(walkController->TreeSize(TRUE));		MeterSetCount(0);		MeterStart();		MeterUpdate(0);		file->Open(TRUE);		export = new(Export_VRML);		export->unitPref = (UnitPreference*)(walkController->GetPreference())->GetPreference(preferUnits);		//VVRMLUNIT	// PRO251		export->cExport();		strcpy(export->texture_ext, transPref->texture_ext);		// PRO25		export->export_textures = transPref->export_textures;		export->SetPolyhedron(pwc(walkController)->root);//jcowen, coplanar fix		export->Open(file, exportInch, 2.54);		err = pwc(walkController)->Export(export);		MeterStop();			export->Close();		export->dExport();				file->Close();			if (err == -2) cancel = TRUE;		}	if (err && created)		file->dFile();	if (err && !cancel)		{		char fileName[256];		file->GetFName(fileName);		sprintf(str, TXTW_SAVEERR, fileName);		AlertMessage(str);		}	return(err);#else	return(-1); // VRML should not be in VR#endif //VWT}// DAS VRML 95.03.24 END#endif // VRML_ANCHORvoidWalkDocument::LaunchController(int	type)	{	V_Window	*aWindow;	LaunchInit	launchInit;	FFixed 		scale = INITFIXXED(0, 0x8000);	char  		str[256];    int			replacedCtrl = FALSE;		switch(type)		{		case toolCRTLWalk:			if(walkController) 				{				while(windows->ALength())					{					windows->Get(0,&aWindow);					if (aWindow)						aWindow->dWindow();					else						windows->Remove(0);					}				walkController->dController();                replacedCtrl = TRUE;				}			walkController = new(CAVWalkController);			walkController->cController(this);			walkController->SetDocument(this);			if (replacedCtrl)				{	// jca 7APR94 we must reset the controllers.  Or Else.				// this can cause crashes under Windows.				fileMenu->SetController(walkController);				editMenu->SetController(walkController);				}	#if VPRO			((CAVWalkController*)walkController)->cAllPalettes();	// ABD TEXTURE //JAM MERGE-GOURAUD-PRO	#endif //VPRO			strcpy(str,title);			SetTitle(str);			break;				default:			launchInit.scale = scale;			walkController->LaunchController(launchInit,type);			break;		}	}	intWalkDocumentStub::cDocument(int query,V_File *file)	{	V_MenuMgr	*gmenu;	type = stubDocument;	gmenu = GetMenuMgr();	aboutMenu = new(MenuAbout);	aboutMenu->ctheMenu(this);	gmenu->Append(aboutMenu);	fileMenu = new(MenuFile);	fileMenu->ctheMenu(this);	gmenu->Append(fileMenu);	editMenu = new(MenuEdit);	editMenu->ctheMenu(this);	gmenu->Append(editMenu);	fileMenu->SetController(NULL);	editMenu->SetController(NULL);		walkFile = file;	// jca 16FEB94 moved out of VR section, so the VWT stub will also be correctly named.#if WINDOWS	SetTitlePrefix(TXT_APPNAME);     // jca 28 Dec 93.  Set the name...#endif#if VR	current_library_2d = NULL;	current_library_3d = NULL;	current_2d_library_num = -1;	current_3d_library_num = -1;	currently_3d = FALSE;#endif // VR			return(TRUE);	}voidWalkDocumentStub::dDocument()	{	aboutMenu->dMenu();	fileMenu->dMenu();	editMenu->dMenu();	if(walkFile) 		{ walkFile->dFile(); walkFile = NULL; }	}void WalkDocumentStub::React(V_Window *window,int type) 	{ 	int	newType;		if(!walkController) return;		newType = walkController->React(window,type);	if(-1 != newType)frontWindowType = newType;	}	int 	WalkDocumentStub::Load(int query) 	{	int err = 0;		switch(query)		{		case LOADOVER:			query = LOADAS;		case LOAD: 		case LOADAS:		case LOADSTART:					NewDocument(0L,query);			#if VPRO			VSendMessage(MSG_SELECT_NO_TEXTURE);	// MERGE-GOURAUD-PRO-7			#endif // VPRO			break;		default:			break;			}				return(err);		}int WalkDocumentStub::Changed(void)	{	int changed = FALSE;	if(walkController)		changed = walkController->Changed();	return(changed);	}int WalkDocumentStub::Empty(void)	{	if(!walkController)return(TRUE);	return(walkController->Empty());	}voidWalkDocumentStub::Preferences()	{	AppPreference *appPref;	PrefDialog	*prefDialog;	int defPref,result = 0 ;	appPref = walkController->GetPreference();		prefDialog = new(PrefDialog);	result = prefDialog->cPrefDialog(walkController, appPref->lastItem);	}int WalkDocumentStub::GetType() { return type; }int WalkDocumentStub::Import(int importType,int format) 	{ 	WalkDocument *doc;	TranslateDialog *importDialog;	V_File	*file;	int	result,killFlag;	if(import == importType && format == format3DDXF)		{		if(!walkController)			{			doc = new(WalkDocument);			doc->OpenDocument(NEW,NULL, NewMDI);			doc->Import(importType,format);			}		else			{			importDialog = new(TranslateDialog);					result = importDialog->cTranslateDialog(walkController,format3DDXF,import);			if(result)				{				file = new(V_File);				file->cFile(LOADAS,appFileTypeDXF,appFileCreatorDXF,appFilterDescriptorDXF,TXTGF_DXF3D);				result = file->Find();				if(!result) 					Import3D(file,format3DDXF);				file->dFile();					}			}		}				return FALSE; 	}intWalkDocumentStub::Import3D(V_File *file,int format)	{							// merge SE, vrmadness		// GJR 7/4/95#if VWT && !SPECIAL_EDITION 	// jca 27AUG94 vrmadness/* jca 17 Sept 93.  Not in VR { */	AppPreference *appPreference;	TranslatorPreference *transPref1,*transPref2;	WalkDocumentStub	*doc;	V_Buffer	*buffer;	int	result = 0;					if(!Changed()  && Untitled())		doc = this;	else		{		doc = new(WalkDocument);		doc->OpenDocument(NEW,NULL, NewMDI);				appPreference = walkController->GetPreference();		transPref1 = (TranslatorPreference*)appPreference->GetPreference(preferTranslator);		appPreference = doc->walkController->GetPreference();		transPref2 = (TranslatorPreference*)appPreference->GetPreference(preferTranslator);		buffer = new(V_Buffer);		buffer->cBuffer(DATA_OUT);		transPref1->IO(buffer);		buffer->IOSetDirection(DATA_IN);		buffer->IOSetPosition(0);		transPref2->IO(buffer);		buffer->dBuffer();		}			if(format3DDXF == format)		Import1(file); 		doc->walkController->SetChange(TRUE);	#endif // VWT.  jca 17 Sept 93 }		return 0;	}	void WalkDocumentStub::SetTitle(strPtr str)	{	if(walkFile)walkFile->SetName(str);	if(walkController)walkController->SetTitle(str);	V_Document::SetTitle(str);	}int WalkDocumentStub::SameFile(V_File *file)	{	char	myName[256],name[256];	int		volume,myVolume;		if(!walkFile||!file) return(FALSE);		myVolume = walkFile->GetVolume();	volume = file->GetVolume();	if(myVolume != volume) return(FALSE);		walkFile->GetFName(myName);	file->GetFName(name);	if(strcmp(myName,name)) return(FALSE);		return(TRUE);	}voidWalkDocumentStub::MoveVRLib(int swap)	{#if VR && WINDOWS	V_Window *libWindow=GetVRLib();	V_Window *walkWindow=GetVRWalk();	V_Window *designWindow=GetVRDesign();	WINDOWPLACEMENT	wp;	Rect	mdiR,libR,infoR,cliR;	HWND	hwnd = GetMDIClient();	extern V_Array *gGalleries3D,*gGalleries2D;		// arrays of library files		// ABD MERGE8 9/3/93	Library* theLib;	infoR = GetInfoWinRect();	GetClientRect(GetFrame(), &cliR);   // get the MDI client size	cliR.bottom -= (infoR.bottom - infoR.top);  // whack out the info win height	GetWindowRect(hwnd, &mdiR);    libR = GetVRLibRect();	if (currently_3d)		theLib = current_library_3d;	else		theLib = current_library_2d;	if(theLib && (swap == 1))		theLib->vis = !(theLib->vis);	if(theLib && theLib->vis && libWindow)		libWindow->Show();	else if(theLib && (!theLib->vis) && libWindow)    	libWindow->Hide();	if (libWindow && libWindow->Visible())		MoveWindow(libWindow->theWindow, libR.left, libR.top, libR.right-libR.left, libR.bottom-libR.top, TRUE);	if(theLib && theLib->vis)		{		if (swap)			{			// the Gallery has just been shown again, so move the windows			if (walkWindow)				{				memset(&wp,0,sizeof(WINDOWPLACEMENT));				wp.length = sizeof(WINDOWPLACEMENT);				GetWindowPlacement(walkWindow->theWindow,&wp);				wp.rcNormalPosition.left -= libR.right-libR.left;				wp.rcNormalPosition.right -= libR.right-libR.left;				SetWindowPlacement(walkWindow->theWindow,&wp);				}			if (designWindow)				{				memset(&wp,0,sizeof(WINDOWPLACEMENT));				wp.length = sizeof(WINDOWPLACEMENT);				GetWindowPlacement(designWindow->theWindow,&wp);				wp.rcNormalPosition.left -= libR.right-libR.left;				wp.rcNormalPosition.right -= libR.right-libR.left;				SetWindowPlacement(designWindow->theWindow,&wp);				}			}		cliR.left += libR.right-libR.left;        }	else if(theLib && (!theLib->vis))		{		cliR.left += libR.right-libR.left;		if (swap)			{            // the Gallery has just been hidden again, so move the windows			if (walkWindow)				{				memset(&wp,0,sizeof(WINDOWPLACEMENT));				wp.length = sizeof(WINDOWPLACEMENT);				GetWindowPlacement(walkWindow->theWindow,&wp);				wp.rcNormalPosition.left += libR.right-libR.left;				wp.rcNormalPosition.right += libR.right-libR.left;				SetWindowPlacement(walkWindow->theWindow,&wp);				}			if (designWindow)				{				memset(&wp,0,sizeof(WINDOWPLACEMENT));				wp.length = sizeof(WINDOWPLACEMENT);				GetWindowPlacement(designWindow->theWindow,&wp);				wp.rcNormalPosition.left += libR.right-libR.left;				wp.rcNormalPosition.right += libR.right-libR.left;				SetWindowPlacement(designWindow->theWindow,&wp);				}			}		cliR.left -= libR.right-libR.left;		}	MoveWindow(GetMDIClient(), cliR.left, cliR.top, cliR.right-cliR.left, cliR.bottom-cliR.top, TRUE);#endif //VR && WINDOWS	}#if VR				voidWalkDocumentStub::OpenVRLib3D(int lib_num)	{		extern V_Array *gGalleries3D;		// array of library files		// ABD MERGE8 9/3/93	V_File *vf, *new_vf;		// ABD MERGE10 9/9/93	char str[255];				// ABD MERGE10 9/9/93	int		moveWindow = FALSE;	Rect	r;    VGrafPort   savePort;    VGrafDevice     saveDevice;//REPLACE						//GJR 10/06/93VfsLocation	*newLocation;					if ((!gGalleries3D) || (VA_Length(gGalleries3D) == 0)) return;		// ABD MERGE8 9/3/93		if ((current_3d_library_num == lib_num) && (currently_3d)) return;					// get the first item in the library gallery list (usually "basic shapes")		gGalleries3D->Get(lib_num, &vf);		// ABD MERGE8 9/3/93				// make a copy so that we can always have a ptr to the file around, even		// after the document is closed//REPLACE								//GJR 10/06/93	[[[		newLocation = new(VfsLocation);		newLocation->cVfsLocation();		vf->VGetLocation(newLocation);							// ABD MERGE10 9/9/93		new_vf = new(V_File);									// ABD MERGE10 9/9/93		new_vf->cFile(REFERENCE,MakeID('?','?','?','?'),MakeID('?','?','?','?'), "", "");		new_vf->VSetLocation(newLocation);						// ABD MERGE10 9/9/93		newLocation->dVfsLocation();		new_vf->Find();											// ABD MERGE10 9/9/93//REPLACE								//GJR 10/06/93	]]]		if (current_library_3d != NULL) 			{		#if MACINTOSH	// jca 3 Oct 93  {			// window can only move on the mac			current_library_3d->libWindow->GetRect(&r);			VGetPort(&savePort,&saveDevice);			VSetPort(current_library_3d->libWindow->theWindow, NULL);			VLocalToGlobalRect(&r, current_library_3d->libWindow->theWindow);			moveWindow = TRUE;			VSetPort(savePort,saveDevice);#endif // MACINTOSH	// jca 3 Oct 93 }			current_library_3d->Close();			gallery3DColorIcons->RemoveAll();	// remove all the existing icons.			gallery3DMonoIcons->RemoveAll();	// remove all the existing icons.			}				if (vf != NULL)		{			current_library_3d = new(Library);			currently_3d = TRUE;			current_library_3d->gallery_3d = TRUE; 		// MERGE15			currentGallery8 = gallery3DColorIcons;	// jca 25 Sept 93.  set the globals			currentGallery1 = gallery3DMonoIcons;	// jca 25 Sept 93.  set the globals			current_library_3d->OpenDocument(LOADSTART, new_vf, NoMDI);			// ABD MERGE10 9/9/93			current_library_3d->InstallSuperDoc(this); // DAS-VR-FLATTEN 9/2/93			current_3d_library_num = lib_num;			current_library_3d->vr_doc = this;     	// ABD MERGE7 9/2/93			currentGallery8 = currentGallery1 = NULL;	// jca 25 Sept 93. { Set to null so they won't get into mischief.			gallery3DColorIcons->Compact(20);		// compact to a multiple of 20			gallery3DMonoIcons->Compact(20);		// jca 25 Sept 93 }#if MACINTOSH // jca 3 Oct 93   {			if (moveWindow)				current_library_3d->libWindow->Move(&r);#elif WINDOWS			r = GetVRLibRect();   // the lib always goes in the same place under windows (tm)			MoveWindow((current_library_3d->libWindow)->GetParentWindow(), r.left, r.top, r.right-r.left, r.bottom-r.top, TRUE);#endif // MACINTOSH   // jca 3 Oct 93 }			current_library_3d->libWindow->Show();		}	}voidWalkDocumentStub::OpenVRLib2D(int lib_num)	{		extern V_Array *gGalleries2D;		// array of library files		// ABD MERGE8 9/3/93	V_File *vf, *new_vf;		// ABD MERGE10 9/9/93	char str[255];				// ABD MERGE10 9/9/93	int			moveWindow = FALSE; 		// jca 1 Oct 93	Rect		r;    VGrafPort   savePort;    VGrafDevice     saveDevice;//REPLACE								//GJR  10/06/93VfsLocation	*newLocation;					if ((!gGalleries2D) || (VA_Length(gGalleries2D) == 0)) return;		// ABD MERGE8 9/3/93		if ((current_2d_library_num == lib_num) && (!currently_3d)) return;					// get the first item in the library gallery list (usually "basic shapes")		gGalleries2D->Get(lib_num, &vf);		// ABD MERGE8 9/3/93				// make a copy so that we can always have a ptr to the file around, even		// after the document is closed//REPLACE								//GJR 10/06/93		newLocation = new(VfsLocation);		newLocation->cVfsLocation();		vf->VGetLocation(newLocation);							// ABD MERGE10 9/9/93		new_vf = new(V_File);									// ABD MERGE10 9/9/93		new_vf->cFile(REFERENCE,MakeID('?','?','?','?'),MakeID('?','?','?','?'), "", "");		new_vf->VSetLocation(newLocation);						// ABD MERGE10 9/9/93		new_vf->Find();											// ABD MERGE10 9/9/93		newLocation->dVfsLocation();		if (current_library_2d != NULL) 			{	#if MACINTOSH     // jca 3 Oct 93 {			// window can only move on the mac			current_library_2d->libWindow->GetRect(&r);			VGetPort(&savePort,&saveDevice);			VSetPort(current_library_2d->libWindow->theWindow, NULL);			VLocalToGlobalRect(&r, current_library_2d->libWindow->theWindow);			VSetPort(savePort,saveDevice);			moveWindow = TRUE;#endif 	// MACINTOSH	// jca 3 Oct 93  }			current_library_2d->Close();			gallery2DColorIcons->RemoveAll();	// remove all the existing icons.			gallery2DMonoIcons->RemoveAll();	// remove all the existing icons.			}							if (vf != NULL)		{			current_library_2d = new(Library);			currently_3d = FALSE;			if (current_library_3d) current_library_3d->gallery_3d = FALSE; 		// MERGE15			currentGallery8 = gallery2DColorIcons;	// jca 25 Sept 93.  set the globals			currentGallery1 = gallery2DMonoIcons;	// jca 25 Sept 93.  set the globals			current_library_2d->OpenDocument(LOADSTART, new_vf, NoMDI);			// ABD MERGE10 9/9/93			current_library_2d->InstallSuperDoc(this); // DAS-VR-FLATTEN 9/2/93			current_2d_library_num = lib_num;			current_library_2d->vr_doc = this;     	// ABD MERGE7 9/2/93						currentGallery8 = currentGallery1 = NULL;	// jca 25 Sept 93. { Set to null so they won't get into mischief.			gallery2DColorIcons->Compact(20);		// compact to a multiple of 20			gallery2DMonoIcons->Compact(20);		// jca 25 Sept 93 }#if MACINTOSH // jca 3 Oct 93   {			if (moveWindow)				current_library_2d->libWindow->Move(&r);#elif WINDOWS   			r = GetVRLibRect();   // the lib always goes in the same place under windows (tm)			MoveWindow((current_library_2d->libWindow)->GetParentWindow(), r.left, r.top, r.right-r.left, r.bottom-r.top, TRUE);#endif // MACINTOSH   // jca 3 Oct 93 }			current_library_2d->libWindow->Show();		}	}voidWalkDocumentStub::OpenTextureLib(int lib_num)	// MERGE14	{		extern V_Array *gTextureArrays;		// array of library files					if ((!gTextureArrays) || (VA_Length(gTextureArrays) == 0)) return;				if ((lib_num < 0) || (lib_num >= VA_Length(gTextureArrays))) return;				gNextTextureLib = lib_num;		// MERGE23		gTextureArrays->Get(lib_num, &gCurrentTextures);	}voidWalkDocumentStub::InitLibs(int lib3d, int lib2d)		// MERGE15	{		OpenVRLib2D(lib2d);			// MERGE15		if (current_library_2d)		// jca 24 Sept 93.  Don't do if nothing there			current_library_2d->libWindow->Hide();		OpenVRLib3D(lib3d);		OpenTextureLib(0);			// MERGE14	}voidWalkDocumentStub::SwitchLibs(int to_2d)	{		Rect r;			// MERGE19    VGrafPort   	savePort;    VGrafDevice     saveDevice;    int				show;		if (to_2d == currently_3d)		{		currently_3d = !currently_3d;		if (current_library_3d && current_library_2d)			if (to_2d)			{#if MACINTOSH	// jca 3 Oct 93   {				// window can only move on the mac				current_library_3d->libWindow->GetRect(&r);				VGetPort(&savePort,&saveDevice);				VSetPort(current_library_3d->libWindow->theWindow, NULL);				VLocalToGlobalRect(&r,current_library_3d->libWindow->theWindow);				VSetPort(savePort,saveDevice);#elif WINDOWS				r = GetVRLibRect();   // the lib always goes in the same place under windows (tm)				MoveWindow((current_library_2d->libWindow)->GetParentWindow(), r.left, r.top, r.right-r.left, r.bottom-r.top, TRUE);#endif // MACINTOSH   // jca 3 Oct 93 }				show = current_library_3d->libWindow->Visible();				current_library_3d->libWindow->Hide();#if MACINTOSH        // jca 3 Oct 93 {				current_library_2d->libWindow->Move(&r);   // this moves it relative to the main doc, not the lib doc.  Oops.#endif // MACINTOSH	 // jca 3 Oct 93 }				if (show)					current_library_2d->libWindow->Show();			}			else			{#if MACINTOSH	// jca 3 Oct 93  {				// window can only move on the mac				current_library_2d->libWindow->GetRect(&r);				VGetPort(&savePort,&saveDevice);				VSetPort(current_library_3d->libWindow->theWindow, NULL);				VLocalToGlobalRect(&r,current_library_3d->libWindow->theWindow);				VSetPort(savePort,saveDevice);#elif WINDOWS				r = GetVRLibRect();   // the lib always goes in the same place under windows (tm)   				MoveWindow((current_library_3d->libWindow)->GetParentWindow(), r.left, r.top, r.right-r.left, r.bottom-r.top, TRUE);#endif // MACINTOSH   // jca 3 Oct 93 }				show = current_library_2d->libWindow->Visible();				current_library_2d->libWindow->Hide();#if MACINTOSH        // jca 3 Oct 93 {				current_library_3d->libWindow->Move(&r);   // this moves it relative to the main doc, not the lib doc.  Oops.#endif // MACINTOSH	 // jca 3 Oct 93 }				if (show)					current_library_3d->libWindow->Show();			}		}	}// jca 27 Sept 93 {V_Window*WalkDocumentStub::GetVRLib()	{	V_Window	*theLib = NULL;		if (VRLibFlag)        {		if (currently_3d)			{			if (current_library_3d)		theLib = current_library_3d->libWindow;			}		else			{			if (current_library_2d)		theLib = current_library_2d->libWindow;			}		}	return(theLib);	}// jca 27 Sept 93 }// jca 23 Nov 93 {// we want to process the gallery swapping messages here in the stub, so// we must redefine the V_Doc::MessageDispatch routine to let us.voidWalkDocumentStub::MessageDispatch(long message,long modifier)	{	if(superDoc)superDoc->MessageDispatch(message,modifier);	else	switch(message)		{		case OPEN_VR_3D_LIB:			OpenVRLib3D(gNextVRLib3D);			break;		case OPEN_VR_2D_LIB:			OpenVRLib2D(gNextVRLib2D);			break;		case OPEN_TEXTURE_LIB:			OpenTextureLib(gNextTextureLib);			break;		default:        	V_Document::MessageDispatch(message, modifier);			break;        }	}// jca 23 Nov 93 }#endif //VR#include <ctype.h>intGetTrailerNumber(char *str)	{	char *token,*test;	int number,length;		number = 0;#if WINDOWS	token = strrchr(str,'-');#elif MACINTOSH	token = strrchr(str,'.');#endif	if(token)		{		test = token;		test++;		length = strlen(test);		while(*test && isdigit(*test))			{			test++;			length--;			}		if(0 == length)			{			test = token;			test++;			sscanf(test,"%i",&number);			*token = 0;			}		}			return number;	}